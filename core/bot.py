import re, uuid
from openpyxl import Workbook
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import ApplicationBuilder,\
                         ContextTypes, CommandHandler,\
                         CallbackQueryHandler, MessageHandler,\
                         filters
from core.bot_session import BotSession
from core.utils import ADMIN_KEYBOARD, USER_KEYBOARD, QUIZZES_MENU_KEYBOARD
from core.filters import StartFilter, RealNameFilter, QuizCreationFilter
from core.quiz import QuizBuilder, QuizCreationError

class QuizBot:
    def __init__(self, token, admins) -> None:
        self._app = ApplicationBuilder().token(token).build()
        self._session = BotSession()
        self._admins = admins
        self._add_handlers()
    
    def _add_handlers(self) -> None:
        start_filter = StartFilter(self._session)
        real_name_filter = RealNameFilter(self._session)
        quiz_creation_filter = QuizCreationFilter(self._session, self._admins)

        self._app.add_handlers([
            CommandHandler('start', self._start_user_session, start_filter),
            MessageHandler(filters.TEXT & real_name_filter, self._set_user_real_name),
            MessageHandler(filters.TEXT & quiz_creation_filter, self._create_quiz),
            CallbackQueryHandler(self._create_quiz, pattern='cancel'),
            CallbackQueryHandler(self._show_quizzes_to_pass, pattern='choose_quiz'),
            CallbackQueryHandler(self._toggle_quiz_status, pattern='toggle:*'),
            CallbackQueryHandler(self._delete_confirmation, pattern='request_deletion:*'),
            CallbackQueryHandler(self._delete_quiz, pattern='delete:*'),
            CallbackQueryHandler(self._init_user_quiz, pattern='choose:*'),
            CallbackQueryHandler(self._manage_quiz, pattern='manage:*'),
            CallbackQueryHandler(self._download_quiz_results, pattern='download:*'),
            CallbackQueryHandler(self._get_quiz_results, pattern='results:*'),
            CallbackQueryHandler(self._submit_quiz_answer, pattern='quize:*'),
            CallbackQueryHandler(self._edit_user_real_name, pattern='edit_real_name'),
            CallbackQueryHandler(self._quizzes_menu, pattern='quizzes_menu'),
            CallbackQueryHandler(self._init_quiz_creation, pattern='create_quiz'),
            CallbackQueryHandler(self._return, pattern='return:*'),
            CallbackQueryHandler(self._show_quizzes_to_manage, pattern='show_quizzes_to_manage')
        ])

    async def _init_quiz_creation(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        chat_id = update.effective_chat.id
        message_id = update.effective_message.id
        self._session.init_quiz_creation(chat_id)

        message = ("–û–∂–∏–¥–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞:\n\n"
                    "–ù–∞–∑–≤–∞–Ω–∏–µ –∫–≤–∏–∑–∞\n"
                    "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤\n"
                    "–ù–æ–º–µ—Ä–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ (–ø—Ä–æ–±–µ–ª –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è)\n"
                    "[$–§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤$] (–ù–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü —Å–µ–∫—Ü–∏–∏ - –∑–Ω–∞–∫ \"$\", —Ç–æ—á–∫–∞ —Å –∑–∞–ø—è—Ç–æ–π –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫)\n"
                    "[~–§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤~] (–ù–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü —Å–µ–∫—Ü–∏–∏ - –∑–Ω–∞–∫ \"~\", —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ - –¥–≤–æ–µ—Ç–æ—á–∏–µ, –º–µ–∂–¥—É –≤–æ–ø—Ä–æ—Å–∞–º–∏ - —Ç–æ—á–∫–∞ —Å –∑–∞–ø—è—Ç–æ–π)]\n"        
                    "–ö–∞–∂–¥—ã–π –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤–≤–æ–¥–∏—Ç—Å—è —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏.\n\n"
                    "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–º–µ—â–µ–Ω–Ω—ã–µ –≤ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —Å–∫–æ–±–∫–∏ —è–≤–ª—è—é—Ç—Å—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏. –ï—Å–ª–∏ –∏—Ö –Ω–µ –∑–∞–¥–∞–≤–∞—Ç—å, –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:\n"
                    "*–¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ - \"–í–æ–ø—Ä–æ—Å ‚Ññ1\", \"–í–æ–ø—Ä–æ—Å ‚Ññ2\"... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –≤–æ–ø—Ä–æ—Å–æ–≤;\n"
                    "* –¥–ª—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤ - –¥–ª—è –≤—Å–µ—Ö –≤–æ–ø—Ä–æ—Å –±—É–¥—É—Ç –∑–∞–¥–∞–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ—Ç 1 –¥–æ 4.")
        
        keyboard = InlineKeyboardMarkup(
            [
                [InlineKeyboardButton('‚Ü©Ô∏è –û—Ç–º–µ–Ω–∞', callback_data='cancel')]
            ]
        )

        await context.bot.edit_message_text(
            text=message,
            chat_id=chat_id,
            message_id=message_id,
            reply_markup=keyboard
        )

    async def _return(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        return_type = update.callback_query.data.split(":")[1]
        message_id = update.effective_message.id

        if return_type == 'menu':
            await self._start_menu(update, context, message_id)
        elif return_type == 'quizzes_menu':
            await self._quizzes_menu(update, context)
        elif return_type == 'quizzes_to_manage':
            await self._show_quizzes_to_manage(update, context)

    async def _toggle_quiz_status(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        chat_id = update.effective_chat.id
        quiz_id = quiz_id = update.callback_query.data.split(':')[1]
        self._session.toggle_quiz_status(chat_id, uuid.UUID(quiz_id))

        await self._manage_quiz(update, context)
    
    async def _delete_quiz(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        chat_id = update.effective_chat.id
        quiz_id = quiz_id = update.callback_query.data.split(':')[1]
        self._session.delete_quiz(chat_id, uuid.UUID(quiz_id))

        await self._show_quizzes_to_manage(update, context)

    async def _download_quiz_results(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        chat_id = update.effective_chat.id
        quiz_id = quiz_id = update.callback_query.data.split(':')[1]

        quiz_name = str(self._session.get_quiz(uuid.UUID(quiz_id)))
        await context.bot.send_document(
                    chat_id,
                    document=quiz_name+'.xlsx'
        )

    async def _get_quiz_results(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        chat_id = update.effective_chat.id
        message_id = update.effective_message.id
        quiz_id = quiz_id = update.callback_query.data.split(':')[1]
        results = self._session.get_quiz_results(uuid.UUID(quiz_id))

        if not results:
            await context.bot.answer_callback_query(
                update.callback_query.id,
                text='–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –∫–≤–∏–∑–∞',
                show_alert=True
            )
        else:
            results.sort(key=lambda x: int(x[1][0]), reverse=True)
            message = '\n'.join(f'[{u.real_name}](https://t.me/{u.username}) - {r}' for u,r in results)
            keyboard = InlineKeyboardMarkup(
                [
                    [InlineKeyboardButton('‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å xlsx –¥–æ–∫—É–º–µ–Ω—Ç', callback_data=f'download:{quiz_id}')],
                    [InlineKeyboardButton('‚Ü©Ô∏è –ù–∞–∑–∞–¥', callback_data=f'manage:{quiz_id}'),
                    InlineKeyboardButton('üè† –î–æ–º–æ–π', callback_data='return:menu')]
                ]
            )

            wb = Workbook()
            sheet = wb.active
            sheet['A1'] = '–§–ò–û'
            sheet['B1'] = '–¢–µ–ª–µ–≥—Ä–∞–º'
            sheet['C1'] = '–†–µ–∑—É–ª—å—Ç–∞—Ç'

            for i, (u, r) in enumerate(results):
                sheet[f'A{i+2}'] = u.real_name
                sheet[f'B{i+2}'] = f'https://t.me/{u.username}'
                sheet[f'C{i+2}'] = r
            
            quiz_name = str(self._session.get_quiz(uuid.UUID(quiz_id)))
            wb.save(quiz_name+'.xlsx')

            await context.bot.edit_message_text(
                chat_id=chat_id,
                message_id=message_id,
                text=message,
                reply_markup=keyboard,
                parse_mode='Markdown'
            )

    async def _delete_confirmation(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        chat_id = update.effective_chat.id
        message_id = update.effective_message.id
        quiz_id = quiz_id = update.callback_query.data.split(':')[1]
        
        keyboard = InlineKeyboardMarkup(
            [
                [InlineKeyboardButton('‚úÖ', callback_data=f'delete:{quiz_id}')],
                [InlineKeyboardButton('‚ùå', callback_data=f'manage:{quiz_id}')]
            ]
        )

        await context.bot.edit_message_text(
            chat_id=chat_id,
            text='–£–≤–µ—Ä–µ–Ω?',
            message_id=message_id,
            reply_markup=keyboard
        )

    async def _manage_quiz(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        chat_id = update.effective_chat.id
        message_id = update.effective_message.id
        quiz_id = quiz_id = update.callback_query.data.split(':')[1]
        quiz_info = self._session.get_quiz(uuid.UUID(quiz_id)).as_dict()

        message = f'*–ù–∞–∑–≤–∞–Ω–∏–µ*: {quiz_info["name"]}\n\n*–í–æ–ø—Ä–æ—Å—ã*:\n'
        for i, (x, y) in enumerate(zip(quiz_info['qa_pairs'], quiz_info['right_answers'])):
            message += f'{i+1}. {x[0]}\n–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤:\n‚Ä¢'
            message += '\n‚Ä¢'.join(x[1])
            message += f'\n(–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç - {y})\n' 
        message += '\n*–°—Ç–∞—Ç—É—Å*: '
        message += 'üü© (–∞–∫—Ç–∏–≤–µ–Ω)' if quiz_info['is_active'] else 'üü• (–Ω–µ–∞–∫—Ç–∏–≤–µ–Ω)'

        keyboard = InlineKeyboardMarkup(
            [
                [InlineKeyboardButton('üîÑ –°–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å', callback_data=f'toggle:{quiz_id}')],
                [InlineKeyboardButton('üìã –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã', callback_data=f'results:{quiz_id}')],
                [InlineKeyboardButton('üóëÔ∏è –£–¥–∞–ª–∏—Ç—å', callback_data=f'request_deletion:{quiz_id}')],
                [InlineKeyboardButton('‚Ü©Ô∏è –ù–∞–∑–∞–¥', callback_data='return:quizzes_to_manage'),
                 InlineKeyboardButton('üè† –î–æ–º–æ–π', callback_data='return:menu')],
            ]
        )

        await context.bot.edit_message_text(
            text=message,
            chat_id=chat_id,
            message_id=message_id,
            reply_markup=keyboard,
            parse_mode='Markdown'
        )

    async def _show_quizzes_to_manage(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        chat_id = update.effective_chat.id
        message_id = update.effective_message.id
        quizes = self._session.get_quizzes()

        if not quizes:
            await context.bot.answer_callback_query(
                update.callback_query.id,
                text='–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∫–≤–∏–∑–æ–≤',
                show_alert=True
            )
        else:
            keyboard = InlineKeyboardMarkup(
                    [[InlineKeyboardButton(
                        str(v), callback_data='manage:'+str(k)
                    )] for k,v  in quizes.items()
                    ] + 
                    [[InlineKeyboardButton('‚Ü©Ô∏è –ù–∞–∑–∞–¥', callback_data='return:quizzes_menu'),
                     InlineKeyboardButton('üè† –î–æ–º–æ–π', callback_data='return:menu')]]
                )
            await context.bot.edit_message_text(
                chat_id=chat_id,
                message_id=message_id,
                text='–í—ã–±–µ—Ä–∏ –∫–≤–∏–∑:',
                reply_markup=keyboard
            )

    async def _quizzes_menu(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        chat_id = update.effective_chat.id
        message_id = update.effective_message.id
        quizes = self._session.get_quizzes().values()

        if quizes:
            message = '–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–≤–∏–∑—ã:\n-' +\
                      '\n-'.join(f'{x} ({"üü©" if x.is_active else "üü•"})' for x in quizes)
        else:
            message = '–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∫–≤–∏–∑–æ–≤'
        
        await context.bot.edit_message_text(
            chat_id=chat_id,
            message_id=message_id,
            text=message,
            reply_markup=QUIZZES_MENU_KEYBOARD
        )

    async def _edit_user_real_name(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        chat_id = update.effective_chat.id
        message_id = update.effective_message.id
        self._session.set_user_real_name(chat_id, None)

        await context.bot.edit_message_text(
            chat_id=chat_id,
            message_id=message_id,
            text='–£–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –í–∞—à–µ –§–ò–û'
        )

    async def _create_quiz(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        chat_id = update.effective_chat.id

        if update.callback_query is not None:
            self._session.cancel_quiz_creation(chat_id)
            await self._quizzes_menu(update, context)
            return

        try:
            quiz = QuizBuilder.create_quiz_from_message(update.effective_message.text)
            self._session.add_quiz(chat_id, quiz)
            await context.bot.send_message(
                chat_id=chat_id,
                text='–ö–≤–∏–∑ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!'
            )
            await self._start_menu(update, context)
        except QuizCreationError as err:
            await context.bot.send_message(
                chat_id=chat_id,
                text=f'{err}. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.'
            )
        except Exception as exc:
            print(exc)
            await context.bot.send_message(
                chat_id=chat_id,
                text='–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–≤–∏–∑–∞. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.'
            )

    async def _start_menu(self, update: Update, context: ContextTypes.DEFAULT_TYPE, message_id: int = None):
        chat_id = update.effective_chat.id
        user_id = update.effective_user.id
        
        if message_id is None:
            await context.bot.send_message(
                chat_id=chat_id,
                text=f'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å,\n{self._session.get_user_real_name(chat_id)}!',
                reply_markup=USER_KEYBOARD if user_id not in self._admins else ADMIN_KEYBOARD
            )
        else:
            await context.bot.edit_message_text(
                chat_id=chat_id,
                message_id = message_id,
                text=f'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å,\n{self._session.get_user_real_name(chat_id)}!',
                reply_markup=USER_KEYBOARD if user_id not in self._admins else ADMIN_KEYBOARD
            )

    async def _set_user_real_name(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        chat_id = update.effective_chat.id
        message_text = update.effective_message.text.strip().lower()

        if not re.match('^([–∞-—è]+ +[–∞-—è]+ +[–∞-—è]+)$', message_text):
            await context.bot.send_message(
                chat_id=chat_id,
                text='–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –§–ò–û. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–∞ –∫–∏—Ä–∏–ª–ª–∏—Ü–µ. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.'
            )
        else:
            real_name = ' '.join(x.capitalize() for x in message_text.split() if x)
            self._session.set_user_real_name(chat_id, real_name)
            await self._start_menu(update, context)

    async def _start_user_session(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        chat_id = update.effective_chat.id
        user_id = update.effective_user.id

        self._session.add_user(
            chat_id,
            update.effective_user.username,
            update.effective_user.first_name,
            user_id,
            user_id in self._admins)

        await context.bot.send_message(
            chat_id=chat_id,
            text='–ñ–¥—É –§–ò–û'
        )
    
    async def _show_quizzes_to_pass(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        chat_id = update.effective_chat.id
        message_id = update.effective_message.id
        active_quizzes = {k: v for k,v in self._session.get_quizzes().items() if v.is_active}
        if not active_quizzes:
            await context.bot.answer_callback_query(
                update.callback_query.id,
                text='–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–≤–∏–∑–æ–≤',
                show_alert=True
            )
        else:
            keyboard = InlineKeyboardMarkup(
                [[InlineKeyboardButton(
                    str(active_quizzes[x]), callback_data='choose:'+str(x)
                )] for x in active_quizzes] +
                [[InlineKeyboardButton('‚Ü©Ô∏è –ù–∞–∑–∞–¥', callback_data='return:menu')]]
            )

            await context.bot.edit_message_text(
                chat_id=chat_id,
                message_id=message_id,
                text='–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–≤–∏–∑—ã:',
                reply_markup=keyboard
            )

    async def _init_user_quiz(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        chat_id = update.effective_chat.id
        message_id = update.effective_message.id
        quiz_id = update.callback_query.data.split(':')[1]

        if self._session.is_user_passed_quiz(chat_id, uuid.UUID(quiz_id)):
            await context.bot.answer_callback_query(
                update.callback_query.id,
                text='–¢—ã —É–∂–µ –ø—Ä–æ—Ö–æ–¥–∏–ª —ç—Ç–æ—Ç –∫–≤–∏–∑',
                show_alert=True
            )
        else:
            self._session.init_user_quiz(chat_id, uuid.UUID(quiz_id))
            quiz_info = self._session.get_user_quiz_info(chat_id, uuid.UUID(quiz_id))
            keyboard = InlineKeyboardMarkup(
                [[InlineKeyboardButton(
                    x, callback_data=f'quize:{quiz_id}:answer:{i+1}'
                )]  for i, x in enumerate(quiz_info[1])]
            )

            await context.bot.edit_message_text(
                chat_id=chat_id,
                message_id=message_id,
                text=quiz_info[0],
                reply_markup=keyboard
            )

    async def _submit_quiz_answer(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        chat_id = update.effective_chat.id
        message_id = update.effective_message.id
        callback_data = update.callback_query.data.split(':')
        quiz_id = callback_data[1]
        answer = int(callback_data[3])

        self._session.update_user_quiz_data(chat_id, uuid.UUID(quiz_id),answer)
        quiz_info = self._session.get_user_quiz_info(chat_id, uuid.UUID(quiz_id))
        if quiz_info is None:
            await context.bot.delete_message(chat_id, message_id)
            await context.bot.send_message(
            chat_id=chat_id,
            text='–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –æ–ø—Ä–æ—Å–∞! –ñ–¥–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç :)'
            )
            self._session.apply_user_results(chat_id, uuid.UUID(quiz_id))
            if update.effective_user.id in self._admins:
                await self._start_menu(update, context)
        else:
            keyboard = InlineKeyboardMarkup(
                [[InlineKeyboardButton(
                    x, callback_data=f'quize:{quiz_id}:answer:{i+1}'
                )]  for i, x in enumerate(quiz_info[1])]
            )

            await context.bot.edit_message_text(
                    quiz_info[0],
                    chat_id,
                    message_id,
                    reply_markup=keyboard
            )

    def run(self) -> None:
        self._app.run_polling()
